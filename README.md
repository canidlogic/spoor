# Spoor

Compile an EPUB-2 publication from source files.

## Syntax

    spoor.pl [options] [files]

`[options]` is a set of program options.  Some options are required, while others are optional.  The options are documented in the next section.

`[files]` is a sequence of one or more paths to the source files to include in the EPUB.  An EPUB is basically a Zip archive of source files together with special metadata.  __The order that files are given on the command line is significant.__

The file extension of each file in `[files]` _must_ be a case-insensitive match for one of the extensions in the following table:

     File extension |                    File type
    ================+==================================================
         .xhtml     |
         .xht       |
         .xml       | Extensible HyperText Markup Language 1.1 (XHTML)
         .html      |
         .htm       |
    ----------------+--------------------------------------------------
         .css       | Cascading Style Sheets 2 (CSS2)
    ----------------+--------------------------------------------------
         .png       | Portable Network Graphics (PNG) image
    ----------------+--------------------------------------------------
         .jpg       | Joint Photographic Experts Group (JPEG) image
         .jpeg      |
    ----------------+--------------------------------------------------
         .svg       | Scalable Vector Graphics 1.1 (SVG)

There must be at least one file of the XHTML type.  The order that XHTML files appear in the `[files]` list determines the order that they will be added to the E-Book.  An implicit page break occurs between each XHTML file.  Although theoretically you should be able to specify page breaks with CSS, in practice many E-Readers do not handle CSS page breaks correctly, so the implicit page breaks between XHTML files are more reliable.  Beware that many E-Readers have incomplete or non-standard interpretations of XHTML/CSS, and that many E-Readers like to override or ignore certain CSS settings.  You are therefore well advised to keep the XHTML/CSS as simple as possible and to test E-Books on target E-Readers.  Spoor does not check XHTML for validity.

__Important:__ Be sure to include an XML declaration `<?xml ?>` at the top of the XHTML files to explicitly declare the character encoding.  E-Readers are not as skilled as mainstream web browsers at deducing the correct character encoding, so you risk character decoding errors unless you explicitly declare the charset.

All resource files referenced from the XHTML file(s) should be included within the EPUB.  Spoor will not check this, though.  The XHTML files and all resource files will be placed within the same directory in the compressed EPUB archive, regardless of the directory paths in the `[files]` arguments.  The filename and extension will be used to name the file within the directory.  __Important:__ this means that when you reference resource files from XHTML, you should always assume that the resource files are in the same directory as the XHTML file.

Note that some EPUB verifiers will throw a warning if you include a resource file such as a cover image that is not referenced from any of the XHTML pages.  To avoid this, you might include a hidden reference to the image in a `div` with style `display: none` so that the resource is referenced but not displayed.

The filename before the extension must be a sequence of at least one US-ASCII alphanumeric or underscore characters.  The total length of the filename with extension must not exceed 255 characters.  In addition, the filename before the extension may not be a case-insensitive match for any of the following (which are special device names under Windows and DOS platforms):

- `AUX`
- `COM1` ... `COM9`
- `CON`
- `LPT1` ... `LPT9`
- `NUL`
- `PRN`

Since all files will be placed within the same directory in the EPUB archive, each filename (with extension) must be unique.  For portability, Spoor enforces uniqueness even under case-insensitive comparisons (since not all file systems are case sensitive).

Although Spoor allows for JPEG, PNG, and SVG images, it is recommended that all images be JPEG due to potentially incomplete E-Reader implementations.  Naturally, it's a good idea to use only common JPEG encodings and ignore exotic JPEG encoding options.  Also note that not all E-Readers have color displays, so make sure color images are legible if rendered in black and white.

For privacy, all files that are added to the EPUB Zip archive will have their modification timestamp changed to the time at which Spoor was run, and have their Unix access attributes set to sane standards.  This prevents true timestamps and Unix access attributes from leaking into the Zip archive.  In the NCX file within the archive, Spoor will note that the NCX file was generated by `spoor` (unless the `-stealth` option is specified) but otherwise Spoor attempts to prevent inadvertent metadata leaks so that EPUB files are safe to publish.

## Options

This section documents the specific `[options]` that can be passed to Spoor.  Some of these options are not optional!

    -out [path]

__Required.__  Declare the output file path where the EPUB will be generated.  If something already exists at the given path, it will be overwritten.

    -meta [path]

__Required.__  Declare the path to the XML metadata file that declares additional metadata for E-Book.  The format of this file is described in the next section.  Metadata within this file will be embedded into the EPUB.  However, Spoor does not guarantee that everything in the given XML metadata file will be included in the EPUB.  Only fields that Spoor understands will be included.

    -cover [mode]

_Optional._  The `[mode]` setting must either be `auto` `none` or `force`.  If this option is not specified, the default of `auto` is assumed.  In `auto` mode, the first file in the file list given to Spoor that is an image file type and that has a name that is a case-insensitive match for `cover` will be registered in the metadata as the cover image.  If there is no such image named `cover` then there will be no cover image.  In `none` mode, there is never a cover image, even if an image file is named `cover`.  `force` mode is the same as `auto` mode, except Spoor will include cover image metatags in both EPUB-2 and EPUB-3 style.  This is useful for use with EPUB converters that only support EPUB-3 cover image declarations.  However, note that `force` mode produces EPUB-2 files that are technically incorrect, since the EPUB-3 cover image declaration is not actually supported in EPUB-2.

    -stealth

_Optional._ If present, this prevents Spoor from adding a metadata header to the generated NCX file that says Spoor generated it.  Spoor always sets all timestamps within the EPUB archive to the time at which Spoor was invoked, regardless of the presence of this option.  Spoor also always sets the Unix access permissions of all files within the EPUB archive to `rw-r--r--` and all directories to `rwxr-xr-x` regardless of the presence of this option.  Note that Spoor does not inspect any of the given files for possible metadata leaks, so even if `-stealth` is specified, it is still up to the user to make sure that no unwanted metadata is present in JPEG files, PNG files, and so forth.

## Metadata XML file format

The top level of the XML metadata file should look like this:

    <?xml encoding="UTF-8"?>
    <spoor format="multi" xml:lang="en">
      ...
    </spoor>

The `format` attribute is required on the root tag.  The two currently supported values are `multi` and `html` (both case insensitive).  `html` mode can only be used when there is exactly one XHTML file, and in this case the navigation section targets are just anchors within that file (see later).  In `multi` mode, there may be more than one XHTML file, and the navigation section targets must name the specific XHTML file in addition to the anchor.

The `xml:lang` attribute is also required on the root tag, which declares the default language used for textual content within the metadata XML file.

Within the top-level element, there are two sections.  The sections may be in any order, but the sections may only appear once each.  Here is the internal section structure:

    <?xml encoding="UTF-8"?>
    <spoor format="multi" xml:lang="en">
      <metadata>
        ...
      </metadata>
      <nav>
        ...
      </nav>
    </spoor>

Both sections are required.

### Metadata section

The metadata section within the XML metadata file declares metadata about the E-Book that will be embedded within the generated EPUB file.

The following table indicates the tags that are supported within the metadata section, whether they are required, whether it is possible to have multiple instances of a tag, and what attributes are supported:

     Metadata tag | Required? | Multiple? |      Attributes
    ==============+===========+===========+======================
        title     |    YES    |    no     | text
       creator    |    no     |    YES    | name, (role), (sort)
     description  |    no     |    no     | *
      publisher   |    no     |    no     | name
     contributor  |    no     |    YES    | name, (role), (sort)
         date     |    no     |    YES    | event, value
      identifier  |    YES    |    no     | scheme, value
        rights    |    no     |    no     | *

Attributes in parentheses are optional, while other attributes are required.  For elements that have an asterisk in the attribute column, this means that the metadata element has no attributes.  Instead, it encloses a plain-text description that is assigned to the attribute.  For example:

    <description>
      The description is enclosed with the
      surrounding &lt;description&gt; tags.
    </description>

Plain-text descriptions of this sort may use XML entities (as shown in the above example for encoding the left and right angle brackets), but they may not use any formatting elements.

Elements that have just a single attribute named `text` or `name` define the value of the corresponding metadata as the text string contained within that attribute value.  For example:

    <title text="Title of my example E-Book"/>

Elements that have a `name` attribute and optional `role` and `sort` attributes specify a required name value that is assigned to the corresponding metadata, optionally an alternate version of that name which is used for purposes of sorting, and optionally a role that determines the relationship of the named person to the work.  For example:

    <creator name="Joe Smith" sort="Smith, Joe" role="aut"/>

The `role` value must consist of exactly three US-ASCII letters (case insensitive).  Only the following roles are allowed:

     Role code |           Role description
    ===========+=======================================
        adp    | Adapter
        ann    | Annotator
        arr    | Arranger
        art    | Artist
        asn    | Associated name
        aut    | Author
        aqt    | Author in quotations or text extracts
        aft    | Author of afterword, colophon, etc.
        aui    | Author of introduction, etc.
        ant    | Bibliographic antecedent
        bkp    | Book producer
        clb    | Collaborator
        cmm    | Commentator
        dsr    | Designer
        edt    | Editor
        ill    | Illustrator
        lyr    | Lyricist
        mdc    | Metadata contact
        mus    | Musician
        nrt    | Narrator
        oth    | Other
        pht    | Photographer
        prt    | Printer
        red    | Redactor
        rev    | Reviewer
        spn    | Sponsor
        ths    | Thesis advisor
        trc    | Transcriber
        trl    | Translator

For more information about the meaning of these roles, see section 2.2.6 of the Opening Packaging Format (OPF) 2.0 specification.

The `date` element associates a specific date with the document.  The `value` attribute must be in format `YYYY-MM-DD` or `YYYY-MM` or `YYYY` according to ISO 8601.  The `event` attribute must be either `creation` `publication` or `modification` (case insensitive).  Each `date` element must have an `event` that is unique within the E-Book, so there can be at most three instances of the `date` element.  For example:

    <date event="creation" value="2021-11-14"/>

Finally, the `identifier` element associates a unique ID with the E-Book.  This should be globally unique somehow, so that it can be used as a unique index for the book within an E-Reader's book catalog.  The `scheme` attribute must be a sequence of one or more US-ASCII alphanumeric characters that identifies (case insensitive) the kind of unique identifier, and the `value` is then the unique identifier of the E-Book within that scheme.  For example, if `ISBN` is used as the scheme, then the value will be the ISBN number that uniquely identifies this E-Book.  If you do not have an ISBN number, you can use the `URL` scheme, which allows you to provide a URL to uniquely identify the E-Book.  For example:

    <identifier scheme="URL" value="http://www.example.com/my-book-url"/>

(The URL is just used for unique identification purposes.  There does not need to be actual data at the URL in question.)

### Nav section

The navigation section of the XML metadata file defines a hierarchical tree structure for navigating through the E-Book, and determines how the nodes of the tree structure map to locations within the E-Book.  This section is required, and must have at least one node within it.

The navigation section tag may optionally have an `xml:lang` attribute that overrides the default language that was marked on the root `spoor` element.  Otherwise, the navigation section inherits the language declared for the `spoor` element.

Each node element within the navigation section may also optionally have an `xml:lang` attribute that explicitly declares the language for that node.  Nodes without an explicit language tag inherit the language of their parent node, or from the navigation section tag if they are a top-level node.

For example, consider the following:

    <nav xml:lang="en">
      <node name="Cover" ... />
      <node name="Introduction"  ... >
        <node name="Example subsection" ... />
        <node name="Je ne sais quoi" xml:lang="fr" ... >
          <node name="Plus de mots" ... />
          <node name="English once again" xml:lang="en" ... />
        </node>
      </node>
      <node name="Chapter 2: An old ending" ... />
      <node name="Chapter 3: A new beginning" ... />
    </nav>

In this navigation section, all nodes have a declared language of `en` (English), except for the _Je ne sais quoi_ node and the _Plus de mots_ node, which both have a declared language of `fr` (French).

These language declarations only apply to the name of the section within the navigation section.  They have no relationship to the language actually used for the text within the book (though of course that is usually the same).

Each node has a `target` that indicates the location within the E-Book that the node corresponds to.  The format of the target varies depending on whether the root `spoor` node has a format of `html` or `multi`.  Since the `html` format of Spoor only supports a single XHTML file, all targets must be anchor locations within this XHTML file.  If the anchor location `#` is used, it means the location is the start of the XHTML file.  Otherwise, the anchor location must begin with `#`, followed by an ASCII letter, followed by a sequence of zero or more US-ASCII alphanumerics and underscores that specify an element ID within the XHTML file that defines the location.  (Spoor does not actually check whether the anchor exists within the XHTML file.)

In the `multi` format, the target must be a case-sensitive match for one of the XHTML files that was passed to Spoor, with an optional anchor after it consisting of a `#` sign followed by an ASCII letter, followed by a sequence of zero or more US-ASCII alphanumerics and underscores that specify an element ID within the XHTML file that defines the location.

Finally, each node has a `name` that is the name of the section when it appears in the navigation structure in the E-Reader.  The language of this text is determined by the language associated with the node, as explained earlier in this section.  No automatic numbering is applied, so if there is some kind of numbering, it should be included in the name.

Example of a full navigation section in `html` format:

    <nav xml:lang="en">
      <node name="Cover" target="#"/>
      <node name="Introduction" target="#intro">
        <node name="Example subsection" target="#subsection"/>
        <node name="Je ne sais quoi" target="#wh" xml:lang="fr">
          <node name="Plus de mots" target="#pdm"/>
          <node name="English once again" xml:lang="en" target="#en"/>
        </node>
      </node>
      <node name="Chapter 2: An old ending" target="#chapter2"/>
      <node name="Chapter 3: A new beginning" target="#chapter3"/>
    </nav>

The `multi` format would be the same way, except each target needs an XHTML file name before the anchor.
